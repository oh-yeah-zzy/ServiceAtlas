{% extends "base.html" %}

{% block content %}
<div class="services-page">
    <div class="page-header">
        <h1>服务管理</h1>
        <button class="btn btn-primary" onclick="showRegisterModal()">
            + 注册服务
        </button>
    </div>

    <div class="services-table-wrapper">
        <table class="services-table">
            <thead>
                <tr>
                    <th>服务 ID</th>
                    <th>名称</th>
                    <th>地址</th>
                    <th>状态</th>
                    <th>类型</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="services-tbody">
                {% for service in services %}
                <tr>
                    <td><code>{{ service.id }}</code></td>
                    <td>{{ service.name }}</td>
                    <td>
                        <a href="{{ service.base_url }}" target="_blank">
                            {{ service.host }}:{{ service.port }}
                        </a>
                    </td>
                    <td>
                        <span class="status-badge status-{{ service.status }}">
                            {{ service.status }}
                        </span>
                    </td>
                    <td>
                        {% if service.is_gateway %}
                        <span class="type-badge gateway">网关</span>
                        {% else %}
                        <span class="type-badge service">服务</span>
                        {% endif %}
                    </td>
                    <td>{{ service.registered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteService('{{ service.id }}')">
                            删除
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="empty-message">暂无注册服务</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 注册服务模态框 -->
<div id="register-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>注册新服务</h2>
            <button class="close-btn" onclick="hideRegisterModal()">&times;</button>
        </div>
        <form id="register-form" onsubmit="registerService(event)">
            <div class="form-group">
                <label for="service-id">服务 ID *</label>
                <input type="text" id="service-id" name="id" required
                       placeholder="如: deckview">
            </div>
            <div class="form-group">
                <label for="service-name">服务名称 *</label>
                <input type="text" id="service-name" name="name" required
                       placeholder="如: DeckView 文档预览服务">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="service-host">地址 *</label>
                    <input type="text" id="service-host" name="host" required
                           placeholder="127.0.0.1">
                </div>
                <div class="form-group">
                    <label for="service-port">端口 *</label>
                    <input type="number" id="service-port" name="port" required
                           placeholder="8000" min="1" max="65535">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="service-protocol">协议</label>
                    <select id="service-protocol" name="protocol">
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="health-check">健康检查路径</label>
                    <input type="text" id="health-check" name="health_check_path"
                           placeholder="/health">
                </div>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is-gateway" name="is_gateway">
                    设为网关服务
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideRegisterModal()">
                    取消
                </button>
                <button type="submit" class="btn btn-primary">注册</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showRegisterModal() {
    document.getElementById('register-modal').classList.add('show');
}

function hideRegisterModal() {
    document.getElementById('register-modal').classList.remove('show');
    document.getElementById('register-form').reset();
}

async function registerService(event) {
    event.preventDefault();
    const form = event.target;
    const data = {
        id: form.id.value,
        name: form.name.value,
        host: form.host.value,
        port: parseInt(form.port.value),
        protocol: form.protocol.value,
        health_check_path: form.health_check_path.value || '/health',
        is_gateway: form.is_gateway.checked
    };

    try {
        // 使用 BASE_PATH 前缀以支持反向代理场景
        const response = await fetch(window.BASE_PATH + '/api/v1/services', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('服务注册成功!');
            location.reload();
        } else {
            const error = await response.json();
            alert('注册失败: ' + (error.detail || '未知错误'));
        }
    } catch (error) {
        alert('注册失败: ' + error.message);
    }
}

async function deleteService(serviceId) {
    if (!confirm(`确定要删除服务 "${serviceId}" 吗?`)) {
        return;
    }

    try {
        // 使用 BASE_PATH 前缀以支持反向代理场景
        const response = await fetch(window.BASE_PATH + `/api/v1/services/${serviceId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('服务已删除');
            location.reload();
        } else {
            const error = await response.json();
            alert('删除失败: ' + (error.detail || '未知错误'));
        }
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}
</script>
{% endblock %}
